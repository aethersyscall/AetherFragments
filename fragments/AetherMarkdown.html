<!DOCTYPE html>
<html lang="en" data-theme="eclipse">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AetherMarkdown | Amethyst Engine</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* 
         * AETHER AMETHYST ENGINE
         * V3.1.0 - Stable Release
         */
        :root {
            --font-ui: 'Inter', system-ui, -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --radius-md: 8px;
            --radius-sm: 4px;
            --trans-speed: 0.2s;
            --header-height: 56px;
            --footer-height: 32px;
        }

        /* PALETTE DEFINITIONS */
        [data-theme="eclipse"] {
            --bg: #13111B;
            --surface: #1B1824;
            --element: #252130;
            --active: #2F2942;
            --border: #2E283B;
            --tx-primary: #EDE8F5;
            --tx-secondary: #9B94A8;
            --tx-muted: #5C5269;

            /* Amethyst Dark Syntax */
            --syn-keyword: #9580FF;
            --syn-func: #FF70B8;
            --syn-type: #D2A8FF;
            --syn-str: #FF9CE6;
            --syn-num: #C26BFF;
            --syn-op: #80FFEA;
            
            --sem-warn: #E0AF68;
            --sem-succ: #80FFEA;
            
            --scroll-track: #13111B;
            --scroll-thumb: #2E283B;
        }

        [data-theme="bliss"] {
            --bg: #FDF7FF;
            --surface: #F4EBFA;
            --element: #EADCF5;
            --active: #DCC2F0;
            --border: #DCC2F0;
            --tx-primary: #3E3245;
            --tx-secondary: #746880;
            --tx-muted: #9E94A8;

            /* Amethyst Light Syntax */
            --syn-keyword: #624CAB;
            --syn-func: #D1006B;
            --syn-type: #8839CE;
            --syn-str: #C22085;
            --syn-num: #7B1FA2;
            --syn-op: #008B8B;

            --sem-warn: #C79200;
            --sem-succ: #008B8B;

            --scroll-track: #FDF7FF;
            --scroll-thumb: #DCC2F0;
        }

        /* RESET & UTILS */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            color: var(--tx-primary);
            font-family: var(--font-ui);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color var(--trans-speed), color var(--trans-speed);
        }

        svg { width: 18px; height: 18px; fill: currentColor; }
        button { font-family: inherit; }

        /* HEADER */
        .app-header {
            height: var(--header-height);
            background-color: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            flex-shrink: 0;
            z-index: 20;
        }

        .brand {
            font-weight: 700;
            font-size: 16px;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--syn-keyword);
        }
        .brand span { color: var(--tx-primary); }

        .toolbar { display: flex; gap: 8px; align-items: center; }

        .btn {
            background: var(--element);
            color: var(--tx-secondary);
            border: 1px solid transparent;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s ease;
        }

        .btn:hover { background: var(--active); color: var(--tx-primary); border-color: var(--border); }
        .btn.primary { background: var(--syn-keyword); color: #fff; }
        .btn-icon-only { padding: 8px; }
        .btn span { display: none; } /* Mobile hide text */

        /* LAYOUT ENGINE (Mobile First) */
        .workspace {
            display: flex;
            flex: 1;
            flex-direction: column; /* Stacked */
            height: calc(100vh - var(--header-height) - var(--footer-height));
            position: relative;
            overflow: hidden;
        }

        .pane {
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
        }

        /* Pane Ordering: Preview Top (-1), Editor Bottom (0) */
        .pane-preview {
            flex: 1;
            order: -1; 
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }

        .pane-editor {
            flex: 1;
            background: var(--bg);
        }

        .pane-header {
            height: 32px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--tx-muted);
            justify-content: space-between;
            flex-shrink: 0;
            user-select: none;
        }

        /* EDITOR PANE */
        .editor-container { flex: 1; position: relative; }
        
        textarea#source-input {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            resize: none;
            padding: 16px;
            font-family: var(--font-mono);
            font-size: 14px;
            line-height: 1.6;
            color: var(--tx-primary);
            caret-color: var(--syn-keyword);
        }

        /* PREVIEW PANE */
        .preview-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px 16px;
            scroll-behavior: smooth;
        }

        /* FOOTER */
        .status-bar {
            height: var(--footer-height);
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            font-size: 11px;
            color: var(--tx-secondary);
            font-family: var(--font-mono);
            flex-shrink: 0;
            z-index: 20;
        }
        .indicator { width: 6px; height: 6px; border-radius: 50%; background: var(--tx-muted); display: inline-block; margin-right: 6px;}
        .indicator.active { background: var(--sem-succ); box-shadow: 0 0 6px var(--sem-succ); }

        /* MARKDOWN TYPOGRAPHY */
        .markdown-body {
            max-width: 800px;
            margin: 0 auto;
            color: var(--tx-primary);
            line-height: 1.6;
            font-size: 15px;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: var(--syn-keyword); margin-top: 1.2em; margin-bottom: 0.5em; line-height: 1.2; }
        .markdown-body h1 { font-size: 1.8em; border-bottom: 1px solid var(--border); padding-bottom: 0.3em; }
        .markdown-body p { margin-bottom: 1em; }
        .markdown-body a { color: var(--syn-op); text-decoration: none; border-bottom: 1px solid transparent; }
        
        /* CODE BLOCK THEME */
        .code-wrapper {
            margin-bottom: 1.5em;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--element);
            overflow: hidden;
        }
        
        .code-header {
            padding: 4px 12px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--tx-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .markdown-body pre {
            padding: 12px;
            overflow-x: auto;
            margin: 0;
            background: transparent;
        }
        
        .markdown-body code {
            font-family: var(--font-mono);
            font-size: 13px;
        }

        /* SYNTAX HIGHLIGHTING (Aether Palette) */
        .hljs-keyword, .hljs-selector-tag { color: var(--syn-keyword); font-weight: 600; }
        .hljs-function, .hljs-title { color: var(--syn-func); }
        .hljs-type, .hljs-built_in, .hljs-class { color: var(--syn-type); }
        .hljs-string, .hljs-regexp { color: var(--syn-str); }
        .hljs-number, .hljs-literal { color: var(--syn-num); }
        .hljs-operator, .hljs-link { color: var(--syn-op); }
        .hljs-comment, .hljs-quote { color: var(--tx-muted); font-style: italic; }
        .hljs-variable, .hljs-attr { color: var(--tx-primary); }

        /* DESKTOP LAYOUT (Tablet+) */
        @media (min-width: 768px) {
            .workspace { flex-direction: row; }
            .pane { flex: 1; height: auto; }
            .pane-preview { order: 0; border-left: 1px solid var(--border); border-bottom: none; }
            .pane-editor { order: 0; }
            .btn span { display: inline; }
            .preview-container { padding: 40px; }
            textarea#source-input { padding: 24px; }
            .pane-header { border-top: none; }
        }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--scroll-track); }
        ::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 4px; border: 2px solid var(--scroll-track); }
    </style>

    <!-- Libs (Pinned to Stable Versions) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

    <!-- Header -->
    <header class="app-header">
        <div class="brand">
            <svg viewBox="0 0 24 24" class="logo-gem"><path d="M12 2L2 9l10 13 10-13-10-7zm0 3.5l6 4.2-6 7.8-6-7.8 6-4.2z"/></svg>
            <span>AetherMarkdown</span>
        </div>
        
        <div class="toolbar">
            <button class="btn" id="theme-toggle" title="Switch Theme">
                <svg viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg>
                <span id="theme-label">Eclipse</span>
            </button>
            <div style="width: 1px; height: 20px; background: var(--border); margin: 0 4px;"></div>
            <button class="btn primary" onclick="aether.exportPDF()" title="Download PDF">
                <svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg>
                <span>PDF Export</span>
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="workspace">
        <!-- Editor Pane -->
        <div class="pane pane-editor">
            <div class="pane-header">
                <span>Input</span>
                <span id="char-count">0</span>
            </div>
            <div class="editor-container">
                <textarea id="source-input" spellcheck="false" placeholder="# Start writing..."></textarea>
            </div>
        </div>

        <!-- Preview Pane -->
        <div class="pane pane-preview">
            <div class="pane-header">
                <span>Preview</span>
                <button class="btn btn-icon-only" style="padding: 2px; height: 24px; width: 24px;" onclick="aether.copyPreview()" title="Copy Text">
                    <svg viewBox="0 0 24 24" style="width: 14px; height: 14px;"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                </button>
            </div>
            <div class="preview-container" id="preview-output">
                <div class="markdown-body" id="render-target"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="status-bar">
        <div class="status-group">
            <div style="display: flex; align-items: center;">
                <div class="indicator active" id="sync-status"></div>
                <span style="margin-left: 4px;">Engine Ready</span>
            </div>
        </div>
        <div class="status-group">
            <span style="opacity: 0.5;">AetherAmethyst v1.0</span>
        </div>
    </footer>

    <script>
        /**
         * AetherMarkdown Core
         * Uses Marked 9.x to ensure 'renderer.code' receives string arguments
         * preventing [object Object] errors seen in Marked 12.x
         */
        const aether = (() => {
            const state = {
                theme: 'eclipse',
                content: localStorage.getItem('aether_content') || "# AetherMarkdown\n\nTheme-aware documentation system.\n\n```typescript\ninterface Gem {\n  type: 'Amethyst';\n  power: number;\n}\n\nfunction glow(): void {\n  console.log('Shining...');\n}\n```",
                timer: null
            };

            const dom = {
                input: document.getElementById('source-input'),
                output: document.getElementById('render-target'),
                root: document.documentElement,
                themeBtn: document.getElementById('theme-toggle'),
                label: document.getElementById('theme-label'),
                count: document.getElementById('char-count'),
                status: document.getElementById('sync-status')
            };

            function init() {
                // Config Marked Renderer for Named Code Blocks
                const renderer = {
                    code(code, infostring) {
                        const lang = (infostring || '').match(/\S*/)[0];
                        const displayLang = lang || 'text';
                        
                        let highlighted = code;
                        // Attempt Highlight.js
                        if (lang && hljs.getLanguage(lang)) {
                            try {
                                highlighted = hljs.highlight(code, { language: lang }).value;
                            } catch (e) {
                                console.warn('Highlight Error:', e);
                            }
                        }

                        // Return the themed block HTML
                        return `
                            <div class="code-wrapper">
                                <div class="code-header">
                                    <span>${displayLang}</span>
                                    <svg width="12" height="12" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                                </div>
                                <pre><code class="hljs language-${lang}">${highlighted}</code></pre>
                            </div>
                        `;
                    }
                };

                // Apply Renderer
                marked.use({ renderer });

                // Load State
                const savedTheme = localStorage.getItem('aether_theme');
                if (savedTheme) switchTheme(savedTheme);

                dom.input.value = state.content;
                render();

                // Events
                dom.input.addEventListener('input', handleInput);
                dom.themeBtn.addEventListener('click', toggleTheme);
            }

            function handleInput(e) {
                state.content = e.target.value;
                clearTimeout(state.timer);
                
                dom.status.className = 'indicator';
                dom.status.style.background = 'var(--sem-warn)';

                state.timer = setTimeout(() => {
                    render();
                    save();
                }, 300);
            }

            function render() {
                try {
                    dom.output.innerHTML = marked.parse(state.content);
                    dom.count.innerText = state.content.length;
                    dom.status.className = 'indicator active';
                    dom.status.style.background = '';
                } catch (e) { console.error(e); }
            }

            function save() {
                localStorage.setItem('aether_content', state.content);
                localStorage.setItem('aether_theme', state.theme);
            }

            function toggleTheme() {
                switchTheme(state.theme === 'eclipse' ? 'bliss' : 'eclipse');
            }

            function switchTheme(name) {
                state.theme = name;
                dom.root.setAttribute('data-theme', name);
                dom.label.innerText = name.charAt(0).toUpperCase() + name.slice(1);
                save();
            }

            async function exportPDF() {
                const btn = document.querySelector('.btn.primary');
                const prevText = btn.innerHTML;
                const userTheme = state.theme;

                btn.innerText = "Processing...";

                // Force Light Mode for clean PDF
                if (userTheme !== 'bliss') {
                    switchTheme('bliss');
                    await new Promise(r => setTimeout(r, 150));
                }

                const element = document.getElementById('render-target');
                const opt = {
                    margin: [10, 10],
                    filename: `aether-doc-${Date.now()}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                try {
                    await html2pdf().set(opt).from(element).save();
                } catch (err) {
                    alert("PDF Generation Failed");
                } finally {
                    if (userTheme !== 'bliss') switchTheme(userTheme);
                    btn.innerHTML = prevText;
                }
            }

            function copyPreview() {
                navigator.clipboard.writeText(dom.output.innerText);
                const btn = document.querySelector('.pane-preview .btn');
                btn.style.color = "var(--sem-succ)";
                setTimeout(() => btn.style.color = "", 1000);
            }

            return { init, exportPDF, copyPreview };
        })();

        window.addEventListener('DOMContentLoaded', aether.init);
    </script>
</body>
</html>
