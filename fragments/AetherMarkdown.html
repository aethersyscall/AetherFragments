<!DOCTYPE html>
<html lang="en" data-theme="eclipse">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AetherMarkdown | Amethyst Engine</title>

  <!-- Typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- KaTeX CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">

  <style id="aether-styles">
    :root {
      --font-ui: 'Outfit', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --radius: 8px;
      --header-h: 60px;
    }

    [data-theme="eclipse"] {
      --bg: #13111B;
      --surface: #1B1824;
      --element: #252130;
      --active: #2F2942;
      --border: #2E283B;
      --fg: #EDE8F5;
      --fg-dim: #9B94A8;
      --acc-p: #9580FF;
      --acc-k: #FF70B8;
      --acc-c: #80FFEA;
      --scroll-track: #13111B;
      --scroll-thumb: #2E283B;
    }

    [data-theme="bliss"] {
      --bg: #FDF7FF;
      --surface: #F4EBFA;
      --element: #EADCF5;
      --active: #DCC2F0;
      --border: #DCC2F0;
      --fg: #3E3245;
      --fg-dim: #746880;
      --acc-p: #624CAB;
      --acc-k: #D1006B;
      --acc-c: #008B8B;
      --scroll-track: #FDF7FF;
      --scroll-thumb: #DCC2F0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      outline: none;
    }

    body {
      background: var(--bg);
      color: var(--fg);
      font-family: var(--font-ui);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* HEADER */
    .header {
      height: var(--header-h);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      flex-shrink: 0;
      z-index: 10;
    }

    .brand {
      font-weight: 800;
      font-size: 1.1rem;
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--acc-p);
    }

    .brand span {
      color: var(--fg);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--acc-c);
      opacity: 0.5;
      transition: 0.3s;
    }

    .status-dot.saving {
      background: var(--acc-k);
      box-shadow: 0 0 8px var(--acc-k);
      opacity: 1;
    }

    .toolbar {
      display: flex;
      gap: 8px;
    }

    .btn {
      background: var(--element);
      color: var(--fg-dim);
      border: 1px solid transparent;
      padding: 8px 14px;
      border-radius: var(--radius);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: 0.2s;
    }

    .btn:hover {
      background: var(--active);
      color: var(--fg);
      border-color: var(--border);
    }

    .btn.primary {
      background: var(--acc-p);
      color: #fff;
    }

    .btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    /* WORKSPACE */
    .workspace {
      display: flex;
      flex: 1;
      height: calc(100vh - var(--header-h));
    }

    .pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    /* EDITOR */
    .pane-editor {
      background: var(--bg);
      border-right: 1px solid var(--border);
    }

    textarea {
      width: 100%;
      height: 100%;
      background: transparent;
      border: none;
      resize: none;
      padding: 30px;
      font-family: var(--font-mono);
      font-size: 14px;
      line-height: 1.7;
      color: var(--fg);
      caret-color: var(--acc-k);
    }

    /* PREVIEW */
    .pane-preview {
      background: var(--bg);
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .preview-content {
      max-width: 800px;
      margin: 0 auto;
      padding: 40px;
    }

    /* MARKDOWN TYPOGRAPHY */
    .md-body {
      line-height: 1.8;
      font-size: 16px;
      color: var(--fg);
    }

    .md-body h1,
    .md-body h2,
    .md-body h3 {
      color: var(--acc-p);
      margin-top: 1.5em;
      margin-bottom: 0.8em;
      font-weight: 700;
      line-height: 1.3;
    }

    .md-body h1 {
      font-size: 2.2rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.3em;
      margin-top: 0;
    }

    .md-body h2 {
      font-size: 1.6rem;
    }

    .md-body h3 {
      font-size: 1.3rem;
      color: var(--acc-k);
    }

    .md-body p {
      margin-bottom: 1.2em;
      color: var(--fg-dim);
    }

    .md-body strong {
      color: var(--fg);
      font-weight: 700;
    }

    .md-body em {
      color: var(--acc-c);
      font-style: normal;
    }

    .md-body ul,
    .md-body ol {
      margin-bottom: 1.2em;
      padding-left: 1.5em;
      color: var(--fg-dim);
    }

    .md-body li {
      margin-bottom: 0.4em;
    }

    .md-body blockquote {
      border-left: 4px solid var(--acc-p);
      margin: 1.5em 0;
      padding: 0.5em 1em;
      background: var(--surface);
      border-radius: 0 var(--radius) var(--radius) 0;
      color: var(--fg);
      font-style: italic;
    }

    /* INLINE CODE */
    .md-body code {
      font-family: var(--font-mono);
      font-size: 0.85em;
      background: var(--element);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--acc-c);
    }

    /* CODE BLOCKS */
    .md-body pre {
      background: var(--surface);
      padding: 16px;
      border-radius: var(--radius);
      overflow-x: auto;
      margin: 1.5em 0;
      border: 1px solid var(--border);
    }

    .md-body pre code {
      background: transparent;
      padding: 0;
      color: inherit;
      font-size: 0.9em;
    }

    /* KaTeX Theme Adjustments */
    .katex {
      font-size: 1.1em !important;
      color: var(--fg) !important;
    }

    .katex-display {
      margin: 1.5em 0 !important;
      overflow-x: auto;
      overflow-y: hidden;
    }

    /* SYNTAX HIGHLIGHTING */
    .md-body .hljs-keyword,
    .md-body .hljs-selector-tag {
      color: var(--acc-p);
      font-weight: 700;
    }

    .md-body .hljs-function,
    .md-body .hljs-title,
    .md-body .hljs-section {
      color: var(--acc-k);
    }

    .md-body .hljs-type,
    .md-body .hljs-built_in,
    .md-body .hljs-class {
      color: var(--acc-c);
    }

    .md-body .hljs-string,
    .md-body .hljs-regexp {
      color: #FF9CE6;
    }

    .md-body .hljs-number,
    .md-body .hljs-literal {
      color: #C26BFF;
    }

    .md-body .hljs-comment,
    .md-body .hljs-quote {
      color: var(--fg-dim);
      font-style: italic;
    }

    .md-body .hljs-variable,
    .md-body .hljs-attr {
      color: var(--fg);
    }

    /* SCROLLBARS */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 99px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    @media (max-width: 768px) {
      .workspace {
        flex-direction: column;
      }

      .pane-editor {
        border-right: none;
        border-bottom: 1px solid var(--border);
      }

      .preview-content,
      textarea {
        padding: 20px;
      }

      .btn span {
        display: none;
      }
    }
  </style>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
</head>

<body>

  <header class="header">
    <div class="brand">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
        <path d="M12 2L2 9l10 13 10-13-10-7zm0 3.5l6 4.2-6 7.8-6-7.8 6-4.2z" />
      </svg>
      <span>AetherMarkdown</span>
      <div id="status" class="status-dot"></div>
    </div>

    <div class="toolbar">
      <button class="btn" id="theme-btn">
        <svg viewBox="0 0 24 24">
          <path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z" />
        </svg>
        <span>Theme</span>
      </button>
      <div style="width:1px; height:20px; background:var(--border); margin:0 4px;"></div>
      <button class="btn" onclick="App.exportHTML()">
        <svg viewBox="0 0 24 24">
          <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" />
        </svg>
        <span>HTML</span>
      </button>
      <button class="btn primary" onclick="App.exportPDF()">
        <svg viewBox="0 0 24 24">
          <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z" />
        </svg>
        <span>PDF</span>
      </button>
    </div>
  </header>

  <main class="workspace">
    <div class="pane pane-editor">
      <textarea id="input" spellcheck="false" placeholder="# Start writing..."></textarea>
    </div>
    <div class="pane pane-preview">
      <div class="preview-content">
        <div id="output" class="md-body"></div>
      </div>
    </div>
  </main>

  <script>
    const App = {
      state: {
        theme: localStorage.getItem('aether_theme') || 'eclipse',
        content: localStorage.getItem('aether_content') || "# Aether + Math\n\nCognitive markdown designed for **focus**.\n\n## Math Support\nWe now support LaTeX via KaTeX.\n\n**Inline:** The equation $E=mc^2$ is famous.\n\n**Block:**\n$$\n\\int_{-\\infty}^\\infty e^{-x^2} dx = \\sqrt{\\pi}\n$$\n\n## Code\n```cpp\n#include <iostream>\nint main() {\n    std::cout << \"Hello Aether\";\n}\n```"
      },
      dom: {
        input: document.getElementById('input'),
        output: document.getElementById('output'),
        status: document.getElementById('status'),
        themeBtn: document.getElementById('theme-btn')
      },
      timer: null,

      init() {
        // --- Marked.js Configuration with Custom KaTeX Tokenizer ---
        
        const tokenizer = {
          // Identify $$ block or $ inline
          code(src) {
            // Block Math: $$ ... $$
            const matchBlock = src.match(/^\$\$([\s\S]+?)\$\$/);
            if (matchBlock) {
              return {
                type: 'katex-block',
                raw: matchBlock[0],
                text: matchBlock[1].trim()
              };
            }
            // Fallback to default code tokenizer
            return false;
          },
          inlineText(src) {
            // Inline Math: $ ... $
            // Prevent matching if $ is escaped or just a currency symbol
            const matchInline = src.match(/^\$([^$\n]+?)\$/);
            if (matchInline) {
              return {
                type: 'katex-inline',
                raw: matchInline[0],
                text: matchInline[1].trim()
              };
            }
            return false;
          }
        };

        const renderer = {
          // Render custom tokens
          code(token) {
            // Intercept our custom type if marked parses it as 'code' fallback
            return false; 
          }
        };

        // Extend marked with custom extension
        marked.use({
          extensions: [
            {
              name: 'katex-block',
              level: 'block',
              tokenizer(src) {
                const match = /^\$\$([\s\S]+?)\$\$/.exec(src);
                if (match) {
                  return {
                    type: 'katex-block',
                    raw: match[0],
                    text: match[1].trim()
                  };
                }
              },
              renderer(token) {
                try {
                  return katex.renderToString(token.text, {
                    displayMode: true,
                    throwOnError: false
                  });
                } catch (err) {
                  return `<div style="color:var(--acc-k)">Error rendering math</div>`;
                }
              }
            },
            {
              name: 'katex-inline',
              level: 'inline',
              start(src) { return src.indexOf('$'); },
              tokenizer(src) {
                const match = /^\$([^$\n]+?)\$/.exec(src);
                if (match) {
                  return {
                    type: 'katex-inline',
                    raw: match[0],
                    text: match[1].trim()
                  };
                }
              },
              renderer(token) {
                try {
                  return katex.renderToString(token.text, {
                    displayMode: false,
                    throwOnError: false
                  });
                } catch (err) {
                  return `<span style="color:var(--acc-k)">??</span>`;
                }
              }
            }
          ]
        });

        // Set Standard Options (Syntax Highlighting)
        marked.setOptions({
          highlight: function(code, lang) {
            const language = hljs.getLanguage(lang) ? lang : 'plaintext';
            return hljs.highlight(code, { language }).value;
          }
        });

        // Load State
        this.setTheme(this.state.theme);
        this.dom.input.value = this.state.content;
        this.render();

        // Listeners
        this.dom.input.addEventListener('input', e => this.handleInput(e));
        this.dom.themeBtn.addEventListener('click', () => this.toggleTheme());
      },

      handleInput(e) {
        this.state.content = e.target.value;
        this.dom.status.classList.add('saving');
        clearTimeout(this.timer);
        this.timer = setTimeout(() => {
          this.render();
          this.save();
          this.dom.status.classList.remove('saving');
        }, 300);
      },

      render() {
        try {
          this.dom.output.innerHTML = marked.parse(this.state.content);
        } catch (e) {
          console.error(e);
        }
      },

      save() {
        localStorage.setItem('aether_content', this.state.content);
        localStorage.setItem('aether_theme', this.state.theme);
      },

      toggleTheme() {
        this.setTheme(this.state.theme === 'eclipse' ? 'bliss' : 'eclipse');
      },

      setTheme(name) {
        this.state.theme = name;
        document.documentElement.setAttribute('data-theme', name);
        this.save();
      },

      exportHTML() {
        const style = document.getElementById('aether-styles').innerHTML;
        const body = this.dom.output.innerHTML;
        const fileName = `aether-math-${Date.now()}.html`;
        
        // Include KaTeX CSS in export for proper math rendering offline
        const katexCSS = `<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">`;

        const html = `<!DOCTYPE html><html data-theme="${this.state.theme}"><head><meta charset="UTF-8"><title>Export</title><link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&family=JetBrains+Mono&display=swap" rel="stylesheet">${katexCSS}<style>${style} body { overflow-y:auto; padding:40px; display:block; height:auto; } .preview-content { max-width:800px; margin:0 auto; } .theme-fab { position:fixed; bottom:20px; right:20px; background:var(--acc-p); color:#fff; border:none; padding:10px 20px; border-radius:99px; font-family:var(--font-ui); font-weight:700; cursor:pointer; }</style></head><body><div class="md-body preview-content">${body}</div><button class="theme-fab" onclick="document.documentElement.dataset.theme = document.documentElement.dataset.theme === 'eclipse' ? 'bliss' : 'eclipse'">Switch Theme</button></body></html>`;

        const blob = new Blob([html], { type: 'text/html' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
      },

      async exportPDF() {
        const btn = document.querySelector('.btn.primary');
        const oldText = btn.innerHTML;
        btn.innerHTML = '...';

        const element = this.dom.output;
        const opt = {
          margin: 20,
          filename: `Aether_${Date.now()}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        const current = this.state.theme;
        if (current !== 'bliss') this.setTheme('bliss');

        await html2pdf().set(opt).from(element).save();

        if (current !== 'bliss') this.setTheme(current);
        btn.innerHTML = oldText;
      }
    };

    window.onload = () => App.init();
  </script>
</body>

</html>
