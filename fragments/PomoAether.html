<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PomoAether // Catppuccin</title>
  <meta name="theme-color" content="#1e1e2e">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
    rel="stylesheet">

  <style>
    /* CATPPUCCIN MOCHA PALETTE */
    :root {
      --bg: #1e1e2e;
      --bg-alt: #181825;
      /* Mantle */
      --bg-card: #313244;
      /* Surface0 */
      --text-main: #cdd6f4;
      --text-muted: #a6adc8;
      --border: #45475a;
      /* Surface1 */

      /* Accents */
      --accent-focus: #f38ba8;
      /* Red */
      --accent-short: #fab387;
      /* Peach */
      --accent-long: #89b4fa;
      /* Blue */
      --accent-success: #a6e3a1;
      /* Green */
      --shadow-color: rgba(24, 24, 37, 0.6);

      /* Dynamic State for SVG Filter */
      --current-theme: var(--accent-focus);
      --glow-blur-amount: 0;
      /* stdDeviation for feGaussianBlur, 0 when off */
      --glow-opacity: 0;
      /* flood-opacity for feFlood, 0 when off */
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, stroke 0.3s ease, filter 0.3s ease;
      -webkit-tap-highlight-color: transparent;
      /* Remove tap highlight on mobile */
    }

    body {
      background-color: var(--bg);
      color: var(--text-main);
      font-family: 'Outfit', sans-serif;
      height: 100vh;
      /* Full viewport height */
      height: 100dvh;
      /* Dynamic viewport height for mobile browsers */
      display: flex;
      flex-direction: column;
      overflow: hidden;
      /* Prevent body scroll, handle internally */
    }

    /* --- Header --- */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      background-color: var(--bg-alt);
      flex-shrink: 0;
      /* Prevent header from shrinking */
      border-bottom: 1px solid var(--border);
    }

    .brand {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand svg {
      color: var(--current-theme);
      transition: color 0.3s ease;
      /* Ensure SVG icon color also transitions */
    }

    .btn-icon {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      display: flex;
      /* For better icon centering */
      align-items: center;
      justify-content: center;
      line-height: 1;
      /* Fix vertical alignment */
    }

    .btn-icon:hover {
      color: var(--text-main);
      background-color: var(--bg-card);
    }

    .btn-icon:active {
      transform: scale(0.95);
    }

    /* Tap feedback */

    /* --- Main Layout --- */
    main {
      flex: 1;
      /* Allow main content to grow and fill available space */
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      overflow-y: auto;
      /* Allow scrolling if content overflows viewport */
      width: 100%;
      max-width: 600px;
      /* Constrain width for larger screens */
      margin: 0 auto;
    }

    /* --- Mode Switcher --- */
    .mode-capsule {
      display: flex;
      background-color: var(--bg-alt);
      padding: 4px;
      border-radius: 50px;
      margin-bottom: 2vh;
      border: 1px solid var(--border);
      width: 100%;
      max-width: 350px;
    }

    .mode-btn {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 10px 0;
      /* Increased padding for better touch target */
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      border-radius: 40px;
      transition: all 0.2s ease;
    }

    .mode-btn.active {
      background-color: var(--bg-card);
      color: var(--current-theme);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .mode-btn:active {
      transform: scale(0.98);
    }

    /* --- Timer Circle --- */
    .timer-container {
      position: relative;
      /* Responsive sizing: takes 75% of viewport width, up to 320px */
      width: min(75vw, 320px);
      height: min(75vw, 320px);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 1vh 0 3vh 0;
      flex-shrink: 0;
      /* Prevent timer from shrinking too much */
    }

    .progress-ring {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .progress-ring__circle {
      transition: stroke-dashoffset 0.35s;
      transform-origin: 50% 50%;
    }

    .timer-bg-circle {
      stroke: var(--bg-card);
    }

    .timer-progress {
      stroke: var(--current-theme);
      /* The glow is now handled by the SVG filter, applied via 'filter' attribute */
    }

    .timer-content {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .time-display {
      font-family: 'JetBrains Mono', monospace;
      font-size: clamp(3rem, 12vw, 4.5rem);
      /* Responsive font size */
      font-weight: 700;
      color: var(--text-main);
      line-height: 1;
      margin-bottom: 0.5rem;
    }

    .status-text {
      font-size: 0.9rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    /* --- Controls --- */
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 3vh;
      width: 100%;
      max-width: 350px;
      justify-content: center;
      flex-shrink: 0;
      /* Prevent controls from shrinking */
    }

    .btn-primary {
      flex: 2;
      background-color: var(--current-theme);
      color: var(--bg);
      border: none;
      padding: 16px;
      font-size: 1.1rem;
      font-weight: 700;
      border-radius: 16px;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-secondary {
      flex: 1;
      background-color: var(--bg-card);
      color: var(--text-main);
      border: 1px solid var(--border);
      padding: 16px;
      border-radius: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      border-color: var(--current-theme);
      color: var(--current-theme);
    }

    .btn-secondary:active {
      transform: scale(0.98);
    }

    /* --- Tasks Section (Mobile Optimized) --- */
    .tasks-panel {
      flex: 1;
      /* Allow tasks panel to grow and take remaining space */
      width: 100%;
      background-color: var(--bg-alt);
      border-radius: 20px 20px 0 0;
      border: 1px solid var(--border);
      border-bottom: none;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      /* Essential for internal scrolling */
      box-shadow: 0 -4px 20px var(--shadow-color);
      min-height: 200px;
      /* Ensure minimum height on small screens */
    }

    .tasks-header {
      padding: 15px 20px;
      background-color: var(--bg-card);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      /* Prevent header from shrinking */
    }

    .tasks-title {
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .tasks-list {
      flex: 1;
      overflow-y: auto;
      /* Enable internal scrolling for tasks */
      padding: 10px;
      list-style: none;
      scrollbar-width: thin;
      scrollbar-color: var(--border) var(--bg-alt);
    }

    .task-item {
      background-color: var(--bg);
      padding: 12px 15px;
      margin-bottom: 8px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      border: 1px solid var(--border);
      transition: all 0.2s ease;
      cursor: pointer;
      /* Indicate clickable area */
    }

    .task-item.active-task {
      border-color: var(--current-theme);
      background-color: rgba(255, 255, 255, 0.02);
    }

    .task-item.completed {
      opacity: 0.5;
    }

    .task-item.completed .task-text {
      text-decoration: line-through;
    }

    .task-check {
      width: 24px;
      height: 24px;
      border: 2px solid var(--text-muted);
      border-radius: 6px;
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      background: transparent;
      color: transparent;
      /* Checkmark invisible until checked */
      transition: all 0.2s ease;
    }

    .task-check:hover {
      border-color: var(--accent-success);
    }

    .task-item.completed .task-check {
      background-color: var(--accent-success);
      border-color: var(--accent-success);
      color: var(--bg);
      /* Checkmark visible */
    }

    .task-text {
      flex: 1;
      font-size: 0.95rem;
      word-break: break-word;
    }

    .task-del {
      background: none;
      border: none;
      color: var(--text-muted);
      padding: 8px;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .task-del:hover {
      color: var(--accent-focus);
    }

    .task-del:active {
      transform: scale(0.95);
    }

    .add-task-form {
      padding: 15px;
      display: flex;
      gap: 10px;
      background-color: var(--bg-alt);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
      /* Prevent form from shrinking */
    }

    .task-input {
      flex: 1;
      background-color: var(--bg);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 12px 15px;
      border-radius: 10px;
      font-family: 'Outfit', sans-serif;
      outline: none;
      font-size: 16px;
      /* Prevents iOS zoom on focus */
      transition: border-color 0.2s ease;
    }

    .task-input:focus {
      border-color: var(--current-theme);
    }

    .btn-add {
      background-color: var(--bg-card);
      color: var(--current-theme);
      border: 1px solid var(--border);
      width: 44px;
      /* Sufficient touch target */
      height: 44px;
      border-radius: 10px;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      /* Prevent button from shrinking */
      transition: all 0.2s ease;
    }

    .btn-add:hover {
      background-color: var(--current-theme);
      color: var(--bg);
    }

    .btn-add:active {
      transform: scale(0.95);
    }

    /* --- Settings Modal --- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
      padding: 20px;
    }

    .modal {
      background-color: var(--bg-alt);
      width: 100%;
      max-width: 350px;
      /* Constrain width for larger screens */
      border-radius: 20px;
      border: 1px solid var(--border);
      padding: 1.5rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s ease;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .setting-row {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .input-group {
      flex: 1;
    }

    .input-group label {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: block;
      margin-bottom: 6px;
    }

    .setting-input {
      width: 100%;
      background-color: var(--bg);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      font-size: 1.1rem;
      transition: border-color 0.2s ease;
    }

    .setting-input:focus {
      border-color: var(--current-theme);
      outline: none;
    }

    /* Animations */
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Landscape orientation and small screens adjustments */
    @media (max-height: 500px) and (orientation: landscape) {
      body {
        height: auto;
        overflow-y: auto;
      }

      main {
        height: auto;
      }

      .timer-container {
        width: 150px;
        height: 150px;
        margin: 10px auto;
      }

      .time-display {
        font-size: 2rem;
      }

      .tasks-panel {
        min-height: 200px;
      }

      .mode-capsule,
      .controls {
        max-width: 100%;
      }
    }
  </style>
</head>

<body>

  <header>
    <div class="brand">
      <!-- PomoAether Icon (color controlled by --current-theme) -->
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"
          stroke="currentColor" stroke-width="2" />
        <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
      </svg>
      <span>PomoAether</span>
    </div>
    <button class="btn-icon" id="btn-settings" title="Settings">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path
          d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
        </path>
      </svg>
    </button>
  </header>

  <main>
    <!-- Mode Toggles -->
    <div class="mode-capsule">
      <button class="mode-btn active" data-mode="focus">Focus</button>
      <button class="mode-btn" data-mode="short">Short Break</button>
      <button class="mode-btn" data-mode="long">Long Break</button>
    </div>

    <!-- Responsive SVG Timer with internal Filter for glow -->
    <div class="timer-container" id="timer-container">
      <svg class="progress-ring" viewBox="0 0 300 300">
        <defs>
          <filter id="circularGlow" x="-50%" y="-50%" width="200%" height="200%">
            <!-- Create a blurred version of the original path -->
            <feGaussianBlur in="SourceGraphic" stdDeviation="var(--glow-blur-amount)" result="blurredShape" />

            <!-- Create a solid color layer using the current theme color -->
            <feFlood flood-color="var(--current-theme)" flood-opacity="var(--glow-opacity)" result="glowColor" />

            <!-- Use the blurred shape as an alpha mask for the glow color -->
            <feComposite in="glowColor" in2="blurredShape" operator="in" result="coloredGlow" />

            <!-- Merge the colored glow BEHIND the original shape -->
            <feMerge>
              <feMergeNode in="coloredGlow" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>
        </defs>
        <circle class="timer-bg-circle" stroke-width="12" fill="transparent" r="130" cx="150" cy="150" />
        <!-- Apply the SVG filter to the progress circle -->
        <circle class="timer-progress" stroke-width="12" fill="transparent" r="130" cx="150" cy="150"
          stroke-linecap="round" filter="url(#circularGlow)" />
      </svg>
      <div class="timer-content">
        <div class="time-display" id="timer">25:00</div>
        <div class="status-text" id="status-text">Ready</div>
      </div>
    </div>

    <!-- Control Buttons -->
    <div class="controls">
      <button class="btn-primary" id="btn-toggle">Start</button>
      <button class="btn-secondary" id="btn-reset">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
          <path d="M3 3v5h5"></path>
        </svg>
      </button>
    </div>

    <!-- Scrollable Task Panel -->
    <div class="tasks-panel">
      <div class="tasks-header">
        <span class="tasks-title">Tasks</span>
        <span class="tasks-title" id="task-count">0/0</span>
      </div>
      <ul class="tasks-list" id="task-list">
        <!-- JS Injects Here -->
      </ul>
      <form class="add-task-form" id="task-form">
        <input type="text" class="task-input" placeholder="Add a new task..." id="new-task-input" required>
        <button type="submit" class="btn-add">+</button>
      </form>
    </div>
  </main>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settings-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 style="font-size: 1.2rem; color: var(--text-main);">Settings</h2>
        <button class="btn-icon" id="close-modal">✕</button>
      </div>

      <div class="setting-row">
        <div class="input-group">
          <label>Focus (min)</label>
          <input type="number" id="setting-focus" class="setting-input" value="25" min="1" max="90">
        </div>
        <div class="input-group">
          <label>Short (min)</label>
          <input type="number" id="setting-short" class="setting-input" value="5" min="1" max="30">
        </div>
        <div class="input-group">
          <label>Long (min)</label>
          <input type="number" id="setting-long" class="setting-input" value="15" min="1" max="60">
        </div>
      </div>

      <button class="btn-primary" style="width: 100%; font-size: 1rem; padding: 12px;" id="save-settings">Save
        Changes</button>
    </div>
  </div>

  <script>
    /* --- Logic Layer --- */
    const state = {
      timeLeft: 25 * 60,
      totalTime: 25 * 60,
      isRunning: false,
      mode: 'focus',
      timerId: null,
      settings: {focus: 25, short: 5, long: 15},
      tasks: []
    };

    const dom = {
      timer: document.getElementById('timer'),
      status: document.getElementById('status-text'),
      circle: document.querySelector('.timer-progress'),
      btnToggle: document.getElementById('btn-toggle'),
      btnReset: document.getElementById('btn-reset'),
      root: document.documentElement,
      taskList: document.getElementById('task-list'),
      taskCount: document.getElementById('task-count'),
      taskForm: document.getElementById('task-form'),
      taskInput: document.getElementById('new-task-input'),
      modal: document.getElementById('settings-modal'),
      timerContainer: document.getElementById('timer-container'), // Added for glow class
      inputs: {
        focus: document.getElementById('setting-focus'),
        short: document.getElementById('setting-short'),
        long: document.getElementById('setting-long')
      }
    };

    // --- Audio ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;

    function initAudio() {
      if (!audioCtx) audioCtx = new AudioContext();
      if (audioCtx.state === 'suspended') {
        // Attempt to resume context on user interaction
        audioCtx.resume().then(() => {
          console.log("AudioContext resumed successfully.");
        }).catch(e => {
          console.error("Failed to resume AudioContext:", e);
        });
      }
    }

    function beep(type) {
      initAudio(); // Ensure context is active before playing sound
      if (!audioCtx) return; // If context still null, something went wrong

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);

      const now = audioCtx.currentTime;

      if (type === 'click') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(600, now);
        gain.gain.setValueAtTime(0.05, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.start(now);
        osc.stop(now + 0.1);
      } else if (type === 'finish') {
        osc.type = 'sine';
        const notes = [523.25, 659.25, 783.99, 987.77];
        notes.forEach((freq, i) => {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.connect(g);
          g.connect(audioCtx.destination);
          o.frequency.value = freq;
          g.gain.setValueAtTime(0.1, now + (i * 0.1));
          g.gain.exponentialRampToValueAtTime(0.001, now + (i * 0.1) + 1);
          o.start(now + (i * 0.1));
          o.stop(now + (i * 0.1) + 1);
        });
      }
    }

    // --- Core Functions ---
    function init() {
      // Load Settings
      const s = localStorage.getItem('pomoConfig');
      if (s) state.settings = JSON.parse(s);

      // Load Tasks
      const t = localStorage.getItem('pomoTasks');
      if (t) state.tasks = JSON.parse(t);

      // Setup Circle
      const radius = dom.circle.r.baseVal.value;
      state.circumference = radius * 2 * Math.PI;
      dom.circle.style.strokeDasharray = `${state.circumference} ${state.circumference}`;

      switchMode('focus');
      renderTasks();
      updateSettingsInputs();
    }

    function updateDisplay() {
      const m = Math.floor(state.timeLeft / 60);
      const s = state.timeLeft % 60;
      dom.timer.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
      document.title = `(${dom.timer.textContent}) PomoAether`;

      // Circle Progress
      const offset = state.circumference - (state.timeLeft / state.totalTime) * state.circumference;
      dom.circle.style.strokeDashoffset = offset;
    }

    function setGlow(on) {
      dom.root.style.setProperty('--glow-blur-amount', on ? '5' : '0'); /* stdDeviation value */
      dom.root.style.setProperty('--glow-opacity', on ? '0.8' : '0'); /* flood-opacity value */
    }

    function switchMode(mode) {
      state.mode = mode;
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

      // Theme colors (mapped to Catppuccin vars)
      let colorVar, text;
      if (mode === 'focus') {colorVar = '--accent-focus'; text = 'Time to Focus';}
      else if (mode === 'short') {colorVar = '--accent-short'; text = 'Short Break';}
      else {colorVar = '--accent-long'; text = 'Long Break';}

      dom.root.style.setProperty('--current-theme', `var(${colorVar})`);
      dom.status.textContent = text;

      // Set Time
      state.totalTime = state.settings[mode] * 60;
      state.timeLeft = state.totalTime;

      if (state.isRunning) toggleTimer(); // stop if running
      setGlow(false); // Turn off glow when switching mode or reset
      updateDisplay();
    }

    function toggleTimer() {
      beep('click'); // Play sound on button click
      if (state.isRunning) {
        clearInterval(state.timerId);
        state.isRunning = false;
        dom.btnToggle.textContent = 'Start';
        setGlow(false);
      } else {
        state.isRunning = true;
        dom.btnToggle.textContent = 'Pause';
        setGlow(true);

        state.timerId = setInterval(() => {
          if (state.timeLeft > 0) {
            state.timeLeft--;
            updateDisplay();
          } else {
            finishTimer();
          }
        }, 1000);
      }
    }

    function finishTimer() {
      clearInterval(state.timerId);
      state.isRunning = false;
      dom.btnToggle.textContent = 'Start';
      beep('finish');
      dom.status.textContent = "Complete!";
      setGlow(false);
      if (Notification.permission === "granted") new Notification("Timer Complete", {body: `${state.mode} session finished!`});
    }

    // --- Tasks ---
    function renderTasks() {
      dom.taskList.innerHTML = '';
      let completedCount = 0;

      state.tasks.forEach((task, i) => {
        if (task.completed) completedCount++;
        const li = document.createElement('li');
        li.className = `task-item ${task.completed ? 'completed' : ''} ${task.active ? 'active-task' : ''}`;
        li.innerHTML = `
                    <button class="task-check" onclick="toggleTask(${i})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </button>
                    <span class="task-text" onclick="setActive(${i})">${task.text}</span>
                    <button class="task-del" onclick="delTask(${i})">✕</button>
                `;
        dom.taskList.appendChild(li);
      });

      dom.taskCount.textContent = `${completedCount}/${state.tasks.length}`;
      localStorage.setItem('pomoTasks', JSON.stringify(state.tasks));
    }

    window.toggleTask = (i) => {state.tasks[i].completed = !state.tasks[i].completed; renderTasks(); beep('click');};
    window.delTask = (i) => {state.tasks.splice(i, 1); renderTasks();};
    window.setActive = (i) => {
      state.tasks.forEach((t, idx) => t.active = idx === i);
      renderTasks();
    };

    dom.taskForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const val = dom.taskInput.value.trim();
      if (val) {
        state.tasks.push({text: val, completed: false, active: false});
        dom.taskInput.value = '';
        renderTasks();
      }
    });

    // --- Events & Settings ---
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', () => switchMode(btn.dataset.mode));
    });
    dom.btnToggle.addEventListener('click', toggleTimer);
    dom.btnReset.addEventListener('click', () => switchMode(state.mode)); // Reset means re-initializing current mode

    // Modal logic
    document.getElementById('btn-settings').onclick = () => dom.modal.style.display = 'flex';
    document.getElementById('close-modal').onclick = () => dom.modal.style.display = 'none';
    document.getElementById('save-settings').onclick = () => {
      state.settings.focus = parseInt(dom.inputs.focus.value) || 25;
      state.settings.short = parseInt(dom.inputs.short.value) || 5;
      state.settings.long = parseInt(dom.inputs.long.value) || 15;

      // Ensure values are within reasonable limits
      state.settings.focus = Math.max(1, Math.min(90, state.settings.focus));
      state.settings.short = Math.max(1, Math.min(30, state.settings.short));
      state.settings.long = Math.max(1, Math.min(60, state.settings.long));

      localStorage.setItem('pomoConfig', JSON.stringify(state.settings));
      if (!state.isRunning) switchMode(state.mode); // Only refresh if timer isn't running
      dom.modal.style.display = 'none';
    };

    function updateSettingsInputs() {
      dom.inputs.focus.value = state.settings.focus;
      dom.inputs.short.value = state.settings.short;
      dom.inputs.long.value = state.settings.long;
    }

    // Request Notification Permission on first user interaction
    document.addEventListener('DOMContentLoaded', () => {
      // Check if Notification API is supported
      if ('Notification' in window) {
        // Request permission if not already granted or denied
        if (Notification.permission === 'default') {
          // It's good practice to request permission on a user gesture
          // For now, we'll request it on initial load to simplify.
          // For a real app, you might want a dedicated button.
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              console.log('Notification permission granted.');
            } else {
              console.warn('Notification permission denied.');
            }
          });
        }
      } else {
        console.warn('Notifications not supported in this browser.');
      }
    });

    // Start the application
    init();

  </script>
</body>

</html>
